# 埋点方案

在实际应用中，很多数据不准确、无法计算的问题最后多数定位到是埋点缺失、错误等造成的，因此严格控制数据质量是非常必要和重要的事情。

埋点方案功能正是通过以下三点来保障数据质量：

1. 数据采集需求管理，方案可共享保证需求来源一致，来源可记录，变更可追踪 —— 通过埋点的增删改、记录变更历史功能实现
2. 将埋点方案作为数据处理规则，规避无效数据污染数据源 —— 通过设定计划外（埋点方案外）的数据处理规则实现
3. 通过埋点方案自动化校验，提高验证效率 —— 通过检测埋点状态功能来实现

![](../../../.gitbook/assets/image%20%28160%29.png)

埋点方案包含两个部分：

* 事件方案——确定上报哪些用户行为
* 用户方案——确定上报哪些用户属性

以下分别说明其使用方法：

## 事件方案

### 1 管理计划中的事件方案

计划中即表示在数据上报前做好了规划要采集的事件；计划外表示不在埋点方案中，但实际上报了数据的事件和属性。

{% hint style="info" %}
通过可视化埋点部署的埋点自动会被视为计划中的事件
{% endhint %}

#### A 添加方案

设计好埋点方案时，方案上传到页面上，支持批量上传或者单条添加

![](../../../.gitbook/assets/image%20%2891%29.png)

**A1 批量上传**

首次使用时建议使用批量上传的方式，上传前，需先下载模板，按照模板中的格式及注意事项进行梳理

![](../../../.gitbook/assets/image%20%2885%29.png)

**A2 单条添加事件**

当已上传过埋点方案，新增少量埋点时，可以选择单条添加

点击列表下方添加事件，列表会自动增加一行，输入要埋点的平台、事件ID、事件显示名称、说明，点击保存即可添加

**A3 单条添加属性**

移入事件行，可以为该事件添加属性。

#### B 修改方案

移入行可以行内编辑事件显示名称、事件说明、属性显示名称、属性名称、数据类型等

对于废弃的埋点也可以移入删除

{% hint style="danger" %}
当属性已回数时，属性的数据类型无法进行修改
{% endhint %}

{% hint style="info" %}
关于删除埋点方案中的事件：

当事件**未回数**时，删除即表示不打算采集，后续有相同事件的数据上报时，将根据设置的数据处理规则处理；

当事件**已回数**时，删除事件仅表示该事件不作为埋点方案，并不会删除其历史数据：

* 删除后该事件会进入到计划外列表中，可以重新添加到埋点方案中
* 对于后续上报的该事件的数据将按照设置的数据处理规则进行处理
{% endhint %}

#### C 查看方案

当有多个平台、多种埋点方式时，可以通过分组、过滤条件、搜索等快速找到相应的埋点

![](../../../.gitbook/assets/image%20%28178%29.png)

**C1 展开/收起全部属性**

点击 **展开全部属性** 可以查看全部事件下的属性

当按分组查看时，默认收起全部分组，点击可以展开全部分组

![](../../../.gitbook/assets/image%20%28116%29.png)

**C2 分组显示**

可以按照的平台、是否预置、埋点方式、是否回数分组查看

![](../../../.gitbook/assets/image%20%2818%29.png)

**C3 过滤条件**

同样支持根据平台、是否预置、埋点方式、是否回数进行过滤

![](../../../.gitbook/assets/image%20%2820%29.png)

### 2 验证和更新埋点状态

上报埋点方案后，系统会根据实际回传的数据与埋点方案做自动化校验，在列表中可以根据颜色标识直观判断当前埋点的状态

**埋点状态 = （事件状态 + 事件属性状态）\* 平台**

![](../../../.gitbook/assets/image%20%2839%29.png)

{% hint style="success" %}
只有平台icon **全部高亮**、事件和属性标识都是 **绿色** 时，表示定义的事件在各个平台上各个属性都有数据回传，且正确
{% endhint %}

{% hint style="warning" %}
当事件前标识是**黄色**时，表示该事件有部分平台没有上报，或者部分属性没有上传完整；可以根据哪个平台icon 未高亮，哪个属性前面的标识为灰色或者黄色来定位具体问题

当属性前标识是**黄色**时，标识该属性有部分平台没有上报；可以查看哪个平台icon未高亮，则标识哪个平台没有上报
{% endhint %}

{% hint style="danger" %}
当平台icon未高亮、事件和属性前标识都为灰色时，标识全部还没有数据上报，或者全部进入错误队列
{% endhint %}

进入页面时会更新最新的埋点回数状态，停留在当前页面时，可以点击右上角 **更新埋点状态** 强制刷新

{% hint style="info" %}
除了以上场景外，有两种特殊情况需要注意：

**1** 当计划外的事件/属性添加到埋点方案中时，会自动高亮实际回数的平台，相应的事件和属性

**2** 定义了A平台的事件和属性，但实际该事件在B平台也回数了时，将自动高亮出该平台
{% endhint %}

### 3 设定计划外事件的处理规则

对于不在埋点方案中，但实际上报了数据的情况，可以自定义设置数据处理规则，更改规则后新进入的数据将按照更新后的规则进行处理，通常1分钟内即可生效。

{% hint style="warning" %}
注意更改规则后仅对新进入的数据生效，根据历史规则处理后的历史数据不会变更。

比如，原来对于计划外的事件，原来选择的是规则 2：数据入库，加入到计划外列表中，默认不启用该事件，手动选择是否加入到埋点方案中

已有一批数据根据此规则处理，其中有10个计划外的埋点在计划外列表中了，此时将处理规则变更为规则1：数据入库，并将事件加入到埋点方案，默认启用该事件。那么，原来进入计划外列表中的10个事件并不会自动添加到埋点方案中，可以手动选择批量添加到埋点计划中
{% endhint %}

![](../../../.gitbook/assets/image%20%28150%29.png)

计划外的事件和属性会有三种情况：

#### A 不在埋点方案中的事件 

* 数据入库，并将事件加入到埋点方案，默认启用该事件
* 数据入库，加入到计划外列表中，默认不启用该事件，手动选择是否加入到埋点方案中【推荐】 
* 数据不入库，加入到错误队列

#### B 事件在，但属性不在埋点方案中的事件属性

* 数据入库，并将事件属性加入到埋点方案，默认启用该属性
* 数据入库，加入到计划外列表中，默认不启用该属性，手动选择是否加入到埋点方案中【推荐】 
* 数据不入库，加入到错误队列

#### C 属性值数据类型错误的属性 

* 整条事件不入库，加入到错误队列【推荐】

![](../../../.gitbook/assets/image%20%2890%29.png)

{% hint style="info" %}
建议数据入库，加入到计划外列表中或者数据不入库，进入错误队列，严格控制数据质量。
{% endhint %}

### 4  计划外事件和属性的处理

若计划外的事件选择数据入口，加入计划外列表，则可以查看所有不在埋点方案中的事件和属性

这时候对于实际也有需要的埋点，可以修改显示名称和说明后加入到埋点方案中

![](../../../.gitbook/assets/image%20%2837%29.png)

也可以全选批量加入到计划中

![](../../../.gitbook/assets/image%20%2824%29.png)

{% hint style="info" %}
若同一个事件即在计划中又在计划外，则表示该事件下有部分属性不在埋点方案中，因为属性不能独立存在，所以事件也会同时显示在计划外列表中。
{% endhint %}

## 用户方案

切换左上角进入到用户方案，可以管理和校验用户属性的埋点

![](../../../.gitbook/assets/image%20%28137%29.png)

### 1 管理计划中用户方案

基本同事件方案，只是批量上传时，使用的模板略有差异

### 2 验证和更新埋点状态

相比事件，仅包含两种状态

* 绿色已回数状态
* 灰色未回数状态，此时未回数也可能是因为数据类型错误导致数据不能正常入口显示，可以在错误数据日志队列中查看或者检查代码

![](../../../.gitbook/assets/image%20%28164%29.png)

### 3 设定计划外属性的处理规则

#### A 计划外的用户属性 

* 数据入库，并将用户属性加入到埋点方案，默认启用该属性
* 数据入库，加入到计划外列表，默认不启用该属性，手动选择是否加入到埋点方案中【推荐】 
* 数据不入库，加入到错误队列

#### B 属性值数据类型错误的属性

* 数据不入库，加入到错误队列【推荐】

![](../../../.gitbook/assets/image%20%2842%29.png)

### 4  计划外属性的处理

同样可以单条或者批量添加到埋点方案中。

![](../../../.gitbook/assets/image%20%28191%29.png)



